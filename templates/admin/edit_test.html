{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h2 class="card-title">Edit Test: {{ test.name if test else 'New Test' }}</h2>
    <form method="POST" class="form" style="max-width: 100%; width: 800px;">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.time_limit.label(class="form-label") }}
        {{ form.time_limit(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.num_questions.label(class="form-label") }}
        {{ form.num_questions(class="form-control") }}
        <small class="form-text">Number of questions to display in test (1 or more).</small>
      </div>
      {{ form.submit(class="btn btn-primary") }}
    </form>
    <h3 class="mt-4">Add Question</h3>
    <form method="POST" enctype="multipart/form-data" class="form mt-4" style="max-width: 100%; width: 800px;">
      {{ q_form.hidden_tag() }}
      <div class="mb-3">
        {{ q_form.type.label(class="form-label") }}
        {{ q_form.type(class="form-select", id="questionType") }}
      </div>
      <div class="mb-3">
        {{ q_form.text.label(class="form-label") }}
        {{ q_form.text(class="form-control") }}
      </div>
      <div class="mb-3" id="optionsContainer">
        {{ q_form.options.label(class="form-label") }}
        {{ q_form.options(class="form-control", id="optionsInput") }}
        <small class="form-text" id="optionsHelp">
          For MCQ/MRQ/TF: Use option builder below or enter JSON array manually. For Flashcard: JSON object, e.g., {"back": "Answer"}. For Match: Use fields below to add terms and definitions (up to 8 pairs).
        </small>
        
        <!-- MCQ/MRQ Option Builder -->
        <div id="mcqFields" style="display: none;">
          <div id="optionList"></div>
          <div class="d-flex gap-2 mt-2">
            <button type="button" class="btn btn-secondary" id="addOption">Add Option</button>
            <button type="button" class="btn btn-info btn-sm" id="toggleJsonView">Toggle JSON View</button>
          </div>
        </div>
        
        <div id="matchFields" style="display: none;">
          <div id="termDefinitionPairs"></div>
          <button type="button" class="btn btn-secondary mt-2" id="addPair">Add Term-Definition Pair</button>
        </div>
      </div>
      <div class="mb-3" id="correctContainer">
        {{ q_form.correct.label(class="form-label") }}
        <div id="correctField">
          <div id="mrqCorrect" style="display: none;">
            <div class="d-flex flex-wrap" style="gap: 15px;">
              {% for choice in [('A', 'A'), ('B', 'B'), ('C', 'C'), ('D', 'D')] %}
                <div class="form-check" style="min-width: 200px;">
                  <input type="checkbox" name="correct" value="{{ choice[0] }}" {{ 'checked' if q_form.correct.data and choice[0] in (q_form.correct.data.split(', ') if q_form.correct.data is string else (q_form.correct.data or [])) }} class="form-check-input">
                  <label class="form-check-label">{{ choice[1] }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
          <div id="matchCorrect" style="display: none;">
            {{ q_form.match_mappings(class="form-control", id="matchMappingsInput", style="display: none;") }}
            <small class="form-text">Mappings are generated from term-definition pairs above.</small>
          </div>
          <div id="otherCorrect" style="display: none;">
            <select name="correct" class="form-control">
              <option value="">Select</option>
              {% for choice in [('A', 'A'), ('B', 'B'), ('C', 'C'), ('D', 'D'), ('true', 'True'), ('false', 'False')] %}
                <option value="{{ choice[0] }}" {{ 'selected' if choice[0] == q_form.correct.data }}>{{ choice[1] }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="mb-3">
        {{ q_form.explanation.label(class="form-label") }}
        {{ q_form.explanation(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ q_form.image.label(class="form-label") }}
        {{ q_form.image(class="form-control", id="imageInput") }}
        <small class="form-text">Upload topology screenshot (PNG/JPG).</small>
        <div id="preview" style="display:none;"><img id="previewImg" alt="Preview" style="max-width: 200px; margin-top: 10px;"></div>
      </div>
      <div class="mb-3">
        {{ q_form.delete_image.label(class="form-label") }}
        {{ q_form.delete_image(class="form-check-input") }}
      </div>
      {{ q_form.submit(class="btn btn-primary") }}
    </form>
    {% if test %}
    <h3 class="mt-4">Questions</h3>
    <div style="max-width: 100%; width: 800px; overflow-x: auto;">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Text</th>
            <th>Type</th>
            <th>Correct</th>
            <th>Image</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for q in questions %}
          <tr>
            <td>{{ q.id }}</td>
            <td style="word-break: break-word; max-width: 300px;">{{ q.text }}</td>
            <td>{{ q.type }}</td>
            <td style="word-break: break-word; max-width: 200px;">
              {% if q.type == 'match' %}
                {% set mappings = q.correct|from_json %}
                {% for term in (q.options|from_json).get('terms', []) %}
                  {% set def = ((q.options|from_json).get('definitions', []) | selectattr('id', 'equalto', mappings.get(term.id|string, '')) | first) %}
                  {{ term.text }}: {{ def.text if def else 'None' }}<br>
                {% endfor %}
              {% else %}
                {{ q.correct|get_full_answer(q.options) }}
              {% endif %}
            </td>
            <td>
              {% if q.image %}
                <img src="{{ url_for('serve_image', filename=q.image) }}" alt="Topology" class="img-thumbnail" width="150">
              {% else %}
                No image
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('admin.edit_question', question_id=q.id) }}" class="btn btn-secondary btn-sm">Edit</a>
              <form method="POST" action="{{ url_for('admin.delete_question', question_id=q.id) }}" class="d-inline">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this question?');">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('imageInput')?.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById('questionType')?.addEventListener('change', function(e) {
  const type = e.target.value;
  const matchFields = document.getElementById('matchFields');
  const mcqFields = document.getElementById('mcqFields');
  const correctContainer = document.getElementById('correctContainer');
  const mrqCorrect = document.getElementById('mrqCorrect');
  const matchCorrect = document.getElementById('matchCorrect');
  const otherCorrect = document.getElementById('otherCorrect');
  
  // Handle options fields
  if (type === 'match') {
    matchFields.style.display = 'block';
    mcqFields.style.display = 'none';
  } else if (['mcq', 'mrq', 'tf'].includes(type)) {
    matchFields.style.display = 'none';
    mcqFields.style.display = 'block';
  } else {
    matchFields.style.display = 'none';
    mcqFields.style.display = 'none';
  }
  
  // Handle correct answers field
  if (type === 'match') {
    correctContainer.style.display = 'none'; // Hide entire correct field for match questions
    matchCorrect.style.display = 'block';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'none';
  } else if (type === 'mrq') {
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'block';
    otherCorrect.style.display = 'none';
  } else if (['mcq', 'tf'].includes(type)) {
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'block';
  } else {
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'block';
  }
});

// MCQ/MRQ Option Builder Functions
document.getElementById('addOption')?.addEventListener('click', function() {
  const optionDiv = document.createElement('div');
  optionDiv.className = 'option-item mb-3';
  optionDiv.innerHTML = `
    <div class="d-flex gap-2 align-items-start flex-wrap">
      <div class="flex-grow-1">
        <textarea class="form-control option-text" rows="3" placeholder="Enter option text (multi-line supported for configurations)" required></textarea>
      </div>
      <button type="button" class="btn btn-danger btn-sm remove-option">Remove</button>
    </div>
  `;
  document.getElementById('optionList').appendChild(optionDiv);
  updateMcqJson();
});

document.getElementById('optionList')?.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-option')) {
    e.target.closest('.option-item').remove();
    updateMcqJson();
  }
});

document.getElementById('optionList')?.addEventListener('input', function(e) {
  if (e.target.classList.contains('option-text')) {
    updateMcqJson();
  }
});

document.getElementById('toggleJsonView')?.addEventListener('click', function() {
  const optionsInput = document.getElementById('optionsInput');
  if (optionsInput.style.display === 'none') {
    optionsInput.style.display = 'block';
    this.textContent = 'Hide JSON View';
  } else {
    optionsInput.style.display = 'none';
    this.textContent = 'Show JSON View';
  }
});

function updateMcqJson() {
  const options = [];
  document.querySelectorAll('.option-text').forEach(textarea => {
    if (textarea.value.trim()) {
      options.push(textarea.value.trim());
    }
  });
  document.getElementById('optionsInput').value = JSON.stringify(options, null, 2);
}

// Match question functions
document.getElementById('addPair')?.addEventListener('click', function() {
  const pairs = document.querySelectorAll('.term-definition-pair').length;
  if (pairs >= 8) {
    alert('Maximum of 8 term-definition pairs allowed.');
    return;
  }
  
  const tempId = 'temp_' + Date.now();
  const pairDiv = document.createElement('div');
  pairDiv.className = 'term-definition-pair mb-3';
  pairDiv.innerHTML = `
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <input type="text" class="form-control term-input" placeholder="Term (e.g., KEK)" data-id="${tempId}" required>
      <input type="text" class="form-control definition-input" placeholder="Definition (e.g., Key Encryption Key)" data-id="${tempId}" required>
      <button type="button" class="btn btn-danger btn-sm remove-pair">Remove</button>
    </div>
  `;
  document.getElementById('termDefinitionPairs').appendChild(pairDiv);
  updateMatchJson();
});

document.getElementById('termDefinitionPairs')?.addEventListener('click', function(e) {
  if (e.target.classList.contains('remove-pair')) {
    e.target.closest('.term-definition-pair').remove();
    updateMatchJson();
  }
});

document.getElementById('termDefinitionPairs')?.addEventListener('input', updateMatchJson);

function updateMatchJson() {
  const terms = [];
  const definitions = [];
  const mappings = {};
  let currentId = 1;
  
  document.querySelectorAll('.term-definition-pair').forEach(pair => {
    const termInput = pair.querySelector('.term-input');
    const definitionInput = pair.querySelector('.definition-input');
    
    if (termInput.value.trim() && definitionInput.value.trim()) {
      const id = currentId.toString();
      terms.push({ id: id, text: termInput.value.trim() });
      definitions.push({ id: id, text: definitionInput.value.trim() });
      mappings[id] = id;
      
      termInput.dataset.id = id;
      definitionInput.dataset.id = id;
      
      currentId++;
    }
  });
  
  document.getElementById('optionsInput').value = JSON.stringify({ terms, definitions }, null, 2);
  document.getElementById('matchMappingsInput').value = JSON.stringify(mappings, null, 2);
}

// Form submission handler
document.querySelector('form[enctype="multipart/form-data"]')?.addEventListener('submit', function(e) {
  const questionType = document.getElementById('questionType').value;
  
  if (questionType === 'match') {
    const pairs = document.querySelectorAll('.term-definition-pair');
    if (pairs.length > 8) {
      e.preventDefault();
      alert('Maximum of 8 term-definition pairs allowed.');
      return;
    }
    for (let pair of pairs) {
      const termInput = pair.querySelector('.term-input');
      const definitionInput = pair.querySelector('.definition-input');
      if (!termInput.value.trim() || !definitionInput.value.trim()) {
        e.preventDefault();
        alert('Please fill in all term and definition fields or remove empty pairs.');
        return;
      }
    }
    updateMatchJson();
  } else if (['mcq', 'mrq', 'tf'].includes(questionType)) {
    updateMcqJson();
  }
});

// Initialize page based on question type
document.addEventListener('DOMContentLoaded', function() {
  const questionType = document.getElementById('questionType')?.value;
  const correctContainer = document.getElementById('correctContainer');
  const mrqCorrect = document.getElementById('mrqCorrect');
  const matchCorrect = document.getElementById('matchCorrect');
  const otherCorrect = document.getElementById('otherCorrect');
  
  if (questionType === 'match') {
    updateMatchJson();
    // Hide the correct field entirely for match questions
    correctContainer.style.display = 'none';
    matchCorrect.style.display = 'block';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'none';
  } else if (questionType === 'mrq') {
    updateMcqJson();
    document.getElementById('optionsInput').style.display = 'none';
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'block';
    otherCorrect.style.display = 'none';
  } else if (['mcq', 'tf'].includes(questionType)) {
    updateMcqJson();
    document.getElementById('optionsInput').style.display = 'none';
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'block';
  } else {
    // Default state - show correct field but hide specific sections
    correctContainer.style.display = 'block';
    matchCorrect.style.display = 'none';
    mrqCorrect.style.display = 'none';
    otherCorrect.style.display = 'block';
  }
});
</script>
{% endblock %}