{% extends 'base.html' %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h2 class="card-title">Edit Question ID: {{ question.id }}</h2>
    <form method="POST" enctype="multipart/form-data" style="max-width: 100%; width: 600px;">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.type.label(class="form-label") }}
        {{ form.type(class="form-select") }}
      </div>
      <div class="mb-3">
        {{ form.text.label(class="form-label") }}
        {{ form.text(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.options.label(class="form-label") }}
        {{ form.options(class="form-control") }}
        <small class="form-text">JSON format, e.g. ["A. Option1", "B. Option2"] for MCQ/MRQ or {"back": "Answer"} for flashcard.</small>
      </div>
      <div class="mb-3">
        {{ form.correct.label(class="form-label") }}
        {% if form.type.data == 'mrq' %}
        {% set raw_options = form.options.data.strip() if form.options.data else '' %}
        {% set options = raw_options.strip('[]').replace('"', '').split(',') if raw_options else [] %}
        {% if options and options|length > 0 %}
        <div class="form-group" style="max-width: 100%; display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">
          {% for opt in options %}
          {% set cleaned_opt = opt.strip() %}
          <div class="form-check" style="flex: 1 1 200px; min-width: 0;">
            <input type="checkbox" name="correct" value="{{ cleaned_opt }}" {{ 'checked' if cleaned_opt in (form.correct.data if form.correct.data is iterable else form.correct.data.split(', ') if form.correct.data else []) }} class="form-check-input">
            <label class="form-check-label">{{ cleaned_opt }}</label>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-danger">No valid options defined for MRQ. Add options first.</p>
        {% endif %}
        {% elif form.type.data == 'mcq' or form.type.data == 'tf' %}
        <select name="correct" class="form-control" style="width: 100%;">
          <option value="">Select</option>
          {% set raw_options = form.options.data.strip() if form.options.data else '' %}
          {% set options = raw_options.strip('[]').replace('"', '').split(',') if raw_options else ['true', 'false'] %}
          {% for opt in options %}
          {% set cleaned_opt = opt.strip() %}
          <option value="{{ cleaned_opt }}" {{ 'selected' if cleaned_opt == form.correct.data }}>{{ cleaned_opt }}</option>
          {% endfor %}
        </select>
        {% elif form.type.data == 'flashcard' %}
        <input type="text" name="correct" value="{{ form.correct.data }}" class="form-control" style="width: 100%;">
        {% endif %}
      </div>
      <div class="mb-3">
        {{ form.explanation.label(class="form-label") }}
        {{ form.explanation(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.image.label(class="form-label") }}
        {{ form.image(class="form-control", id="imageInput") }}
        <small class="form-text">Upload topology screenshot (PNG/JPG).</small>
        <div id="preview" style="display:none;"><img id="previewImg" alt="Preview" style="max-width: 200px; margin-top: 10px;"></div>
        {% if form.delete_image %}
        <div class="form-check">
          {{ form.delete_image(class="form-check-input") }}
          {{ form.delete_image.label(class="form-check-label") }}
        </div>
        {% endif %}
      </div>
      {{ form.submit(class="btn btn-primary") }}
    </form>
    <script>
    document.getElementById('imageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    </script>
  </div>
</div>
{% endblock %}