{% extends 'base.html' %}
{% block content %}
<h2>{{ test.name }} - {{ mode|capitalize }} Mode</h2>
<form id="quizForm">
    {% for q in questions %}
    <div class="question mb-4">
        <p>{{ loop.index }}. {{ q.text }}</p>
        {% if q.image %}<img src="{{ url_for('static', filename='uploads/' + q.image) }}" alt="Question image" class="img-fluid mb-3">{% endif %}
        {% if q.type == 'mcq' %}
            {% for opt in json.loads(q.options) %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_{{ loop.index }}" value="{{ opt }}">
                <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
            </div>
            {% endfor %}
        {% elif q.type == 'tf' %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_true" value="True">
                <label class="form-check-label" for="q{{ q.id }}_true">True</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_false" value="False">
                <label class="form-check-label" for="q{{ q.id }}_false">False</label>
            </div>
        {% elif q.type == 'flashcard' %}
            <textarea name="q{{ q.id }}" class="form-control" placeholder="Enter your answer"></textarea>
        {% endif %}
        {% if mode == 'study' %}
        <div class="answer mt-2" style="display:none;">
            <strong>Correct:</strong> {{ q.correct }}<br>
            <strong>Explanation:</strong> {{ q.explanation }}
        </div>
        <button type="button" class="btn btn-secondary mt-2 show-answer">Show Answer</button>
        {% endif %}
    </div>
    {% endfor %}
    {% if mode == 'study' %}
    <button type="button" class="btn btn-primary" onclick="submitQuiz();">Submit for History</button>
    {% endif %}
</form>
<script>
document.querySelectorAll('.show-answer').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.previousElementSibling.style.display = 'block';
        btn.style.display = 'none';  // Optional: Hide button after show
    });
});

function submitQuiz() {
    let answers = {};
    document.querySelectorAll('.question').forEach(q => {
        let id = q.querySelector('input, textarea').name.replace('q', '');
        let selected = q.querySelector('input:checked') || q.querySelector('textarea');
        answers[id] = selected ? selected.value : '';
    });
    let score = calculateScore(answers);  // Client-side score for immediate feedback
    fetch(window.location.href, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({answers: answers, score: score})
    }).then(res => res.json()).then(data => {
        if (data.status === 'saved') {
            alert(`Score: ${score}% - Saved to history!`);
            window.location.href = '{{ url_for("history") }}';  // Redirect to history
        } else {
            alert('Error saving: ' + data.message);
        }
    });
}

function calculateScore(answers) {
    let correct = 0;
    let total = {{ questions|length }};
    // Note: For accurate scoring, server-side is better (correct answers not exposed client-side)
    // This is placeholder; in production, compute on server and return score in response
    return Math.round((correct / total) * 100);
}
</script>
{% endblock %}