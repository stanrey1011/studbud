{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h2 class="card-title">{{ test.name }} - Study Mode</h2>
    <form id="quizForm">
      {% for q in questions %}
      <div class="card question mb-4">
        <div class="card-body">
          <h4>Question ID: {{ q.id }}</h4>
          <p>{{ q.text }}</p>
          {% if q.image %}
          <img src="{{ url_for('static', filename='Uploads/' + q.image) }}" alt="Question image" class="img-fluid mb-3">
          {% endif %}
          {% if q.type == 'mcq' %}
          {% for opt in q.parsed_options %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_{{ loop.index }}" value="{{ opt }}">
            <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
          </div>
          {% endfor %}
          {% elif q.type == 'mrq' %}
          {% for opt in q.parsed_options %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="q{{ q.id }}" id="q{{ q.id }}_{{ loop.index }}" value="{{ opt }}">
            <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
          </div>
          {% endfor %}
          {% elif q.type == 'tf' %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_true" value="True">
            <label class="form-check-label" for="q{{ q.id }}_true">True</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" id="q{{ q.id }}_false" value="False">
            <label class="form-check-label" for="q{{ q.id }}_false">False</label>
          </div>
          {% elif q.type == 'flashcard' %}
          <div class="mb-3">
            <label class="form-label">Answer:</label>
            <textarea name="q{{ q.id }}" class="form-control" placeholder="Enter your answer"></textarea>
          </div>
          {% endif %}
          {% if mode == 'study' %}
          <div class="feedback correct mt-2" style="display:none;">
            <strong>Correct:</strong> {{ q.correct }}<br>
            <strong>Explanation:</strong> {{ q.explanation }}
          </div>
          <button type="button" class="btn btn-secondary mt-2 show-answer">Show Answer</button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
      <button type="button" class="btn btn-primary" onclick="submitQuiz();">Submit for History</button>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.querySelectorAll('.show-answer').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.previousElementSibling.style.display = 'block';
    btn.style.display = 'none';
  });
});

function submitQuiz() {
  let answers = {};
  document.querySelectorAll('.question').forEach(q => {
    let id = q.querySelector('input, textarea').name.replace('q', '');
    if (q.querySelector('input[type="checkbox"]')) {
      let selected = Array.from(q.querySelectorAll('input:checked')).map(input => input.value);
      answers[id] = selected;
    } else {
      let selected = q.querySelector('input:checked') || q.querySelector('textarea');
      answers[id] = selected ? selected.value : '';
    }
  });
  let score = calculateScore(answers);
  fetch(window.location.href, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({answers: answers, score: score})
  }).then(res => res.json()).then(data => {
    if (data.status === 'saved') {
      alert(`Score: ${score}% - Saved to history!`);
      window.location.href = '{{ url_for("user.history") }}';
    } else {
      alert('Error saving: ' + data.message);
    }
  });
}

function calculateScore(answers) {
  let correct = 0;
  let total = {{ questions|length }};
  // Placeholder: Server-side scoring in user.py is accurate
  return Math.round((correct / total) * 100);
}
</script>
{% endblock %}